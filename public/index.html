<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Wine Cellar</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="Manage your wine collection with AI-powered recommendations and multi-source ratings">
  <meta name="theme-color" content="#722F37">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Wine Cellar">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Wine Cellar">
  <meta name="msapplication-TileColor" content="#1a1a2e">
  <meta name="msapplication-TileImage" content="/images/icon-144.png">

  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">

  <!-- Preconnect for fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <h1>Wine Cellar</h1>
    <button class="search-trigger" id="global-search-trigger" aria-label="Search">
      <span>üîç</span>
      <span>Search...</span>
      <kbd>‚åòK</kbd>
    </button>
    <div class="stats" id="stats">
      <div class="stat">
        <div class="stat-value" id="stat-total">-</div>
        <div class="stat-label">Bottles</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-reduce">-</div>
        <div class="stat-label">Reduce Now</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-empty">-</div>
        <div class="stat-label">Empty Slots</div>
      </div>
    </div>
  </header>

  <nav class="tabs" aria-label="Main navigation">
    <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Open menu" aria-expanded="false" aria-controls="tabs-container">
      <span></span><span></span><span></span>
    </button>
    <div class="tabs-container" id="tabs-container" role="tablist" aria-label="Views">
      <button class="tab active" data-view="grid" role="tab" aria-selected="true" aria-controls="view-grid" id="tab-grid">Cellar Grid</button>
      <button class="tab" data-view="analysis" role="tab" aria-selected="false" aria-controls="view-analysis" id="tab-analysis">Cellar Analysis</button>
      <button class="tab" data-view="pairing" role="tab" aria-selected="false" aria-controls="view-pairing" id="tab-pairing">Find Pairing</button>
      <button class="tab" data-view="wines" role="tab" aria-selected="false" aria-controls="view-wines" id="tab-wines">Wine List</button>
      <button class="tab" data-view="history" role="tab" aria-selected="false" aria-controls="view-history" id="tab-history">History</button>
      <button class="tab" data-view="settings" role="tab" aria-selected="false" aria-controls="view-settings" id="tab-settings">Settings</button>
    </div>
  </nav>

  <main id="main-content">
  <!-- Grid View -->
  <div class="view active" id="view-grid" role="tabpanel" aria-labelledby="tab-grid">
    <!-- AI Drink Recommendations Panel -->
    <section class="recommendation-panel" id="drink-tonight-panel">
      <div class="recommendation-header">
        <h2>Tonight's Recommendations</h2>
        <div class="recommendation-actions">
          <button class="btn btn-small btn-icon" id="refresh-recommendations" title="Get new suggestions">
            <span class="refresh-icon">‚Üª</span>
          </button>
          <button class="btn btn-small btn-icon" id="toggle-recommendations" title="Hide panel" aria-expanded="true">
            <span class="toggle-icon">‚àí</span>
          </button>
        </div>
      </div>
      <p class="recommendation-subtitle">AI-curated based on your cellar, drinking windows, and preferences</p>

      <div class="recommendation-context" id="recommendation-context">
        <span class="context-label">Context:</span>
        <select id="rec-occasion" class="context-select">
          <option value="">Any occasion</option>
          <option value="casual dinner">Casual dinner</option>
          <option value="special occasion">Special occasion</option>
          <option value="party">Party</option>
          <option value="solo relaxing">Solo relaxing</option>
        </select>
        <select id="rec-food" class="context-select">
          <option value="">Any food</option>
          <option value="red meat">Red meat</option>
          <option value="poultry">Poultry</option>
          <option value="seafood">Seafood</option>
          <option value="pasta">Pasta</option>
          <option value="cheese">Cheese</option>
          <option value="no food">No food</option>
        </select>
        <input type="text" id="rec-food-detail" class="context-input" placeholder="Describe dish... e.g. barbecue chicken, salmon with lemon" />
      </div>

      <div class="recommendation-cards" id="recommendation-cards">
        <!-- Initial placeholder shown until user clicks Get Recommendations -->
      </div>
    </section>

    <div class="fridge-section zone">
      <div class="zone-header">
        <span class="zone-title">Fridge</span>
      </div>
      <div class="fridge-grid" id="fridge-grid"></div>
    </div>

    <div class="zone">
      <div class="zone-header">
        <span class="zone-title">Cellar</span>
      </div>
      <div class="cellar-container">
        <div class="zone-labels" id="zone-labels"></div>
        <div class="cellar-grid" id="cellar-grid"></div>
      </div>
    </div>
  </div>

  <!-- Analysis View -->
  <div class="view" id="view-analysis" role="tabpanel" aria-labelledby="tab-analysis" hidden>
    <div class="analysis-view-header">
      <h2>Cellar Analysis</h2>
      <div class="analysis-actions">
        <button class="btn btn-primary" id="refresh-analysis-btn">Refresh Analysis</button>
        <button class="btn btn-secondary" id="get-ai-advice-btn">Get AI Advice</button>
        <button class="btn btn-secondary" id="setup-zones-btn">Setup Zones</button>
      </div>
    </div>

    <div class="analysis-summary" id="analysis-summary">
      <div class="analysis-loading">Loading analysis...</div>
    </div>
    <div class="analysis-alerts" id="analysis-alerts"></div>

    <!-- Zone Setup Wizard -->
    <div class="zone-setup-wizard" id="zone-setup-wizard" style="display: none;">
      <div class="wizard-header">
        <h3>Zone Setup Wizard</h3>
        <p class="wizard-subtitle">Review and confirm the proposed zone layout for your cellar</p>
        <button class="btn btn-small btn-secondary" id="toggle-zone-chat-btn" onclick="window.cellarAnalysis.toggleZoneChat()">
          üí¨ Chat About Zones
        </button>
      </div>

      <!-- Zone Chat Panel -->
      <div class="zone-chat-panel" id="zone-chat-panel" style="display: none;">
        <div class="zone-chat-header">
          <span>Zone Classification Chat</span>
          <button class="btn-icon" onclick="window.cellarAnalysis.toggleZoneChat()" title="Close chat">‚úï</button>
        </div>
        <div class="zone-chat-messages" id="zone-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-content">
              <p>I'm here to help you review and adjust zone classifications. You can:</p>
              <ul>
                <li>Ask why a specific wine is in a certain zone</li>
                <li>Challenge a classification you disagree with</li>
                <li>Request reclassification of wines</li>
                <li>Ask about zone boundaries and rules</li>
              </ul>
              <p>Try asking: "Why is [wine name] in the dessert zone?" or "Move my Amarone to the appassimento zone"</p>
            </div>
          </div>
        </div>
        <div class="zone-chat-input-container">
          <input type="text" id="zone-chat-input" placeholder="Ask about zone classifications..."
                 onkeypress="if(event.key==='Enter') window.cellarAnalysis.sendZoneChatMessage()">
          <button class="btn btn-primary btn-small" onclick="window.cellarAnalysis.sendZoneChatMessage()">Send</button>
        </div>
      </div>

      <div class="wizard-step" id="wizard-step-1">
        <h4>Step 1: Review Proposed Layout</h4>
        <p>Based on your 122 bottles, here's the suggested zone arrangement:</p>
        <div class="zone-proposal-list" id="zone-proposal-list">
          <div class="analysis-loading">Generating proposal...</div>
        </div>
        <div class="wizard-actions">
          <button class="btn btn-primary" id="confirm-layout-btn">Confirm Layout</button>
          <button class="btn btn-secondary" id="cancel-setup-btn">Cancel</button>
        </div>
      </div>

      <div class="wizard-step" id="wizard-step-2" style="display: none;">
        <h4>Step 2: Execute Moves</h4>
        <p>Now let's move your bottles to their designated zones. Work through zone by zone:</p>
        <div class="zone-moves-wizard" id="zone-moves-wizard">
          <div class="analysis-loading">Generating moves...</div>
        </div>
      </div>
    </div>

    <!-- Fridge Status Section -->
    <div class="analysis-fridge" id="analysis-fridge" style="display: none;">
      <h3>Fridge Status</h3>
      <div class="fridge-status-content" id="fridge-status-content"></div>
    </div>

    <!-- Zone Narratives Section -->
    <div class="analysis-zones" id="analysis-zones" style="display: none;">
      <h3>Zone Overview</h3>
      <div class="zone-cards-grid" id="zone-cards-grid"></div>
    </div>

    <!-- Suggested Moves Section -->
    <div class="analysis-moves" id="analysis-moves">
      <h3>Suggested Moves</h3>
      <div class="moves-list" id="moves-list"></div>
      <div class="moves-actions" id="moves-actions" style="display: none;">
        <button class="btn btn-primary btn-small" id="execute-all-moves-btn">Execute All Moves</button>
      </div>
    </div>

    <!-- AI Advice Section -->
    <div class="analysis-ai-advice" id="analysis-ai-advice" style="display: none;"></div>
  </div>

  <!-- Wine List View (merged Reduce Now + All Wines) -->
  <div class="view" id="view-wines" role="tabpanel" aria-labelledby="tab-wines" hidden>
    <div class="wine-list-header">
      <h2>Wine List</h2>
      <div class="wine-list-filters">
        <div class="filter-group">
          <label class="filter-chip">
            <input type="checkbox" id="filter-reduce-now" />
            <span>Drink Soon</span>
          </label>
        </div>
        <div class="filter-group">
          <select id="filter-colour">
            <option value="">All Colours</option>
            <option value="red">Red</option>
            <option value="white">White</option>
            <option value="rose">Ros√©</option>
            <option value="sparkling">Sparkling</option>
          </select>
        </div>
        <div class="filter-group">
          <select id="filter-sort">
            <option value="name">Sort: Name</option>
            <option value="vintage-asc">Sort: Oldest First</option>
            <option value="vintage-desc">Sort: Newest First</option>
            <option value="rating">Sort: Rating</option>
            <option value="price">Sort: Price</option>
            <option value="count">Sort: Quantity</option>
          </select>
        </div>
        <div class="filter-group search-group">
          <input type="text" id="filter-search" placeholder="Search wines..." />
        </div>
      </div>
    </div>
    <div class="wine-list-stats" id="wine-list-stats"></div>
    <div class="wine-list" id="wine-list"></div>
  </div>

  <!-- History View -->
  <div class="view" id="view-history" role="tabpanel" aria-labelledby="tab-history" hidden>
    <h2 style="margin-bottom: 1rem;">Consumption History</h2>
    <div class="history-list" id="history-list"></div>
  </div>

  <!-- Pairing View -->
  <div class="view" id="view-pairing" role="tabpanel" aria-labelledby="tab-pairing" hidden>
    <!-- Sommelier section -->
    <div class="natural-pairing">
      <h2 style="margin-bottom: 1rem;">Ask the Sommelier</h2>
      <input type="text" id="dish-input" placeholder="Describe your dish... e.g., 'grilled salmon with lemon butter'" />
      <div class="pairing-filters">
        <div class="filter-group">
          <span class="filter-label">Source:</span>
          <label><input type="radio" name="source" value="all" checked> All wines</label>
          <label><input type="radio" name="source" value="reduce_now"> Reduce-now only</label>
        </div>
        <div class="filter-group">
          <span class="filter-label">Colour:</span>
          <label><input type="radio" name="colour" value="any" checked> Any</label>
          <label><input type="radio" name="colour" value="red"> Red</label>
          <label><input type="radio" name="colour" value="white"> White</label>
          <label><input type="radio" name="colour" value="rose"> Rose</label>
        </div>
      </div>
      <button class="btn btn-primary" id="ask-sommelier">Ask Sommelier</button>
    </div>

    <div id="sommelier-results"></div>

    <hr style="margin: 2rem 0; border-color: var(--border); opacity: 0.3;">

    <!-- Manual pairing section -->
    <div class="pairing-form">
      <h3 style="margin-bottom: 1rem;">Or select manually</h3>
      <h4 style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">PROTEIN</h4>
      <div class="signal-grid">
        <button class="signal-btn" data-signal="chicken">Chicken</button>
        <button class="signal-btn" data-signal="pork">Pork</button>
        <button class="signal-btn" data-signal="beef">Beef</button>
        <button class="signal-btn" data-signal="lamb">Lamb</button>
        <button class="signal-btn" data-signal="fish">Fish</button>
        <button class="signal-btn" data-signal="cheese">Cheese</button>
      </div>
      <h4 style="font-size: 0.8rem; color: var(--text-muted); margin: 1rem 0 0.5rem;">FLAVOURS</h4>
      <div class="signal-grid">
        <button class="signal-btn" data-signal="garlic_onion">Garlic/Onion</button>
        <button class="signal-btn" data-signal="herbal">Herbal</button>
        <button class="signal-btn" data-signal="roasted">Roasted</button>
        <button class="signal-btn" data-signal="acid">Acidic/Citrus</button>
        <button class="signal-btn" data-signal="sweet">Sweet</button>
        <button class="signal-btn" data-signal="umami">Umami</button>
        <button class="signal-btn" data-signal="creamy">Creamy</button>
      </div>
      <button class="btn btn-primary" style="margin-top: 1.5rem;" id="get-pairing">Find Pairing</button>
      <button class="btn btn-secondary" style="margin-top: 1.5rem;" id="clear-signals">Clear</button>
    </div>

    <h3 style="margin: 1.5rem 0 1rem;">Suggestions</h3>
    <div class="pairing-results" id="pairing-results">
      <p style="color: var(--text-muted);">Select dish characteristics above</p>
    </div>
  </div>

  <!-- Settings View -->
  <div class="view" id="view-settings" role="tabpanel" aria-labelledby="tab-settings" hidden>
    <h2 style="margin-bottom: 1.5rem;">Settings</h2>

    <!-- Rating Preferences Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Rating Preferences</h3>
      <p class="settings-section-desc">Adjust how professional ratings are weighted when calculating purchase scores.</p>

      <div class="preference-slider-container">
        <div class="preference-labels">
          <span>Community</span>
          <span>Balanced</span>
          <span>Competition</span>
        </div>
        <input type="range" id="rating-preference-slider" min="-100" max="100" value="40" class="preference-slider" />
        <div class="preference-value">
          <span id="preference-value-display">+40</span>
          <span id="preference-description">Slightly favors competition awards</span>
        </div>
      </div>
    </div>

    <!-- Display Settings Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Display Settings</h3>
      <p class="settings-section-desc">Adjust text size for better readability on your device.</p>

      <fieldset class="text-size-selector">
        <legend class="settings-label">Text Size</legend>
        <div class="text-size-options">
          <label class="text-size-option">
            <input type="radio" name="text-size" value="small" />
            <span class="text-size-btn">A<span class="size-label">Small</span></span>
          </label>
          <label class="text-size-option">
            <input type="radio" name="text-size" value="medium" checked />
            <span class="text-size-btn">A<span class="size-label">Medium</span></span>
          </label>
          <label class="text-size-option">
            <input type="radio" name="text-size" value="large" />
            <span class="text-size-btn">A<span class="size-label">Large</span></span>
          </label>
        </div>
        <p class="text-size-preview">Preview: The quick brown fox jumps over the lazy dog.</p>
      </fieldset>
    </div>

    <!-- Reduce-Now Auto Rules Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Reduce-Now Auto Rules</h3>
      <p class="settings-section-desc">Automatically suggest wines to add to your reduce-now list based on criteria.</p>

      <div class="settings-toggle-row">
        <label class="toggle-switch">
          <input type="checkbox" id="reduce-auto-rules-enabled" />
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Enable automatic suggestions</span>
      </div>

      <div class="settings-rules" id="reduce-rules-container">
        <h4 class="settings-subsection-title">Drinking Window Rules</h4>

        <div class="settings-rule">
          <label for="reduce-urgency-months">Flag wines closing within</label>
          <div class="rule-input-group">
            <select id="reduce-urgency-months">
              <option value="6">6 months</option>
              <option value="12" selected>12 months</option>
              <option value="18">18 months</option>
              <option value="24">24 months</option>
              <option value="36">36 months</option>
            </select>
          </div>
        </div>

        <div class="settings-toggle-row settings-rule">
          <label class="toggle-switch">
            <input type="checkbox" id="reduce-include-no-window" checked />
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">Include wines without drinking window data (uses age fallback)</span>
        </div>

        <h4 class="settings-subsection-title">Fallback Rules (for wines without window data)</h4>

        <div class="settings-rule">
          <label for="reduce-age-threshold">Suggest wines when vintage is older than</label>
          <div class="rule-input-group">
            <input type="number" id="reduce-age-threshold" min="1" max="50" value="10" />
            <span>years</span>
          </div>
        </div>

        <div class="settings-rule">
          <label for="reduce-rating-minimum">Suggest wines when rating is below</label>
          <div class="rule-input-group">
            <input type="number" id="reduce-rating-minimum" min="1" max="5" step="0.5" value="3.0" />
            <span>stars</span>
          </div>
        </div>

        <button class="btn btn-secondary" id="evaluate-rules-btn">
          Evaluate Now
        </button>
      </div>

      <!-- Evaluation Results -->
      <div id="reduce-candidates-container" style="display: none;">
        <h4 style="margin: 1rem 0 0.5rem;">Matching Wines</h4>
        <div id="reduce-candidates-list"></div>
        <div class="reduce-candidates-actions">
          <button class="btn btn-primary btn-small" id="add-all-candidates-btn">Add All to Reduce-Now</button>
          <button class="btn btn-secondary btn-small" id="clear-candidates-btn">Dismiss</button>
        </div>
      </div>
    </div>

    <!-- Storage Conditions Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Storage Conditions</h3>
      <p class="settings-section-desc">Adjust drinking window estimates based on your storage temperature. Warmer storage accelerates wine ageing.</p>

      <div class="settings-toggle-row">
        <label class="toggle-switch">
          <input type="checkbox" id="storage-adjustment-enabled" />
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Enable storage-based window adjustment</span>
      </div>

      <div id="storage-options-container" class="settings-rules">
        <div class="settings-rule">
          <label for="storage-temp-bucket">Storage temperature range</label>
          <div class="rule-input-group">
            <select id="storage-temp-bucket">
              <option value="cool">Cool (10-15¬∞C / 50-59¬∞F)</option>
              <option value="moderate">Moderate (15-20¬∞C / 59-68¬∞F)</option>
              <option value="warm">Warm (20-24¬∞C / 68-75¬∞F)</option>
              <option value="hot">Hot (24¬∞C+ / 75¬∞F+)</option>
            </select>
          </div>
        </div>

        <div id="storage-temp-description" class="settings-rule-desc">
          10-15¬∞C - Ideal cellar conditions, no window adjustment
        </div>

        <div class="settings-toggle-row settings-rule">
          <label class="toggle-switch">
            <input type="checkbox" id="storage-heat-risk" />
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">Heat risk - Wines exposed to 30¬∞C+ temps (adds warning flag)</span>
        </div>
      </div>
    </div>

    <!-- Account Credentials Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Account Credentials</h3>
      <p class="settings-section-desc">Connect your accounts for enhanced rating data. Credentials are encrypted.</p>

      <div id="encryption-warning" class="settings-warning" style="display: none;">
        No encryption key configured. Add CREDENTIAL_ENCRYPTION_KEY to your .env file for persistent storage.
      </div>

      <!-- Vivino -->
      <div class="credential-form">
        <div class="credential-header">
          <span class="credential-source">Vivino</span>
          <span class="credential-status" id="vivino-status">Not configured</span>
        </div>
        <div class="credential-note">
          Note: Vivino blocks server-side API access. Ratings are found via search snippets instead.
        </div>
        <div class="credential-inputs">
          <input type="email" id="vivino-username" placeholder="Email" autocomplete="off" />
          <input type="password" id="vivino-password" placeholder="Password" autocomplete="off" />
        </div>
        <div class="credential-actions">
          <button class="btn btn-small btn-secondary" id="vivino-save-btn">Save</button>
          <button class="btn btn-small btn-secondary" id="vivino-test-btn" style="display: none;">Test</button>
          <button class="btn btn-small btn-danger" id="vivino-delete-btn" style="display: none;">Remove</button>
        </div>
      </div>

      <!-- Decanter -->
      <div class="credential-form">
        <div class="credential-header">
          <span class="credential-source">Decanter</span>
          <span class="credential-status" id="decanter-status">Not configured</span>
        </div>
        <div class="credential-note">
          Decanter credentials enable access to full review pages with scores and drinking windows.
        </div>
        <div class="credential-inputs">
          <input type="email" id="decanter-username" placeholder="Email" autocomplete="off" />
          <input type="password" id="decanter-password" placeholder="Password" autocomplete="off" />
        </div>
        <div class="credential-actions">
          <button class="btn btn-small btn-secondary" id="decanter-save-btn">Save</button>
          <button class="btn btn-small btn-secondary" id="decanter-test-btn" style="display: none;">Test</button>
          <button class="btn btn-small btn-danger" id="decanter-delete-btn" style="display: none;">Remove</button>
        </div>
      </div>

      <!-- Source Info -->
      <div class="source-info">
        <h4>Other Rating Sources</h4>
        <p>Ratings from these sources are found via web search (no login required):</p>
        <ul>
          <li><strong>James Suckling, Wine Spectator, Wine Advocate</strong> - Critic scores</li>
          <li><strong>IWC, DWWA, Platters</strong> - Competition awards</li>
          <li><strong>CellarTracker</strong> - Community ratings (via search)</li>
          <li><strong>Jancis Robinson</strong> - Expert ratings</li>
        </ul>
      </div>
    </div>

    <!-- Awards Database Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Awards Database</h3>
      <p class="settings-section-desc">Import competition awards from various sources for automatic matching with your cellar.</p>

      <!-- Import New Awards -->
      <div class="awards-import-section">
        <h4 class="settings-subsection-title">Import Awards</h4>

        <div class="awards-import-form">
          <div class="import-row">
            <div class="form-field">
              <label for="awards-competition">Competition</label>
              <select id="awards-competition">
                <option value="">Select competition...</option>
              </select>
            </div>
            <div class="form-field" id="custom-competition-field" style="display: none;">
              <label for="custom-competition-name">Competition Name</label>
              <input type="text" id="custom-competition-name" placeholder="e.g. My Local Wine Show" />
            </div>
            <div class="form-field">
              <label for="awards-year">Year</label>
              <input type="number" id="awards-year" min="2000" max="2030" placeholder="2024" />
            </div>
          </div>

          <div class="import-type-tabs">
            <button class="import-tab active" data-import-type="webpage">From URL</button>
            <button class="import-tab" data-import-type="pdf">From PDF</button>
            <button class="import-tab" data-import-type="text">Paste Text</button>
          </div>

          <div class="import-input-area" id="import-webpage-input">
            <label for="awards-url">Awards Page URL</label>
            <input type="url" id="awards-url" placeholder="https://www.trophywineshow.co.za/winners-and-results/" />
            <p class="form-hint">If no awards are found, the page may load dynamically. Try: Print page to PDF (Ctrl+P ‚Üí Save as PDF) and use PDF import instead.</p>
          </div>

          <div class="import-input-area" id="import-pdf-input" style="display: none;">
            <label for="awards-pdf">Upload PDF(s)</label>
            <input type="file" id="awards-pdf" accept="application/pdf" multiple />
            <p class="form-hint">Select multiple files. Year is auto-detected from filename (e.g., "VERITAS 2024.pdf").</p>
            <div id="pdf-files-list" class="pdf-files-list"></div>
          </div>

          <div class="import-input-area" id="import-text-input" style="display: none;">
            <label for="awards-text">Paste Awards List</label>
            <textarea id="awards-text" rows="6" placeholder="Paste text from digital magazine, CSV, or any awards list..."></textarea>
          </div>

          <button class="btn btn-primary" id="import-awards-btn">Import Awards</button>
          <div id="import-progress" class="import-progress" style="display: none;">
            <div class="progress-spinner"></div>
            <span>Extracting awards...</span>
          </div>
        </div>
      </div>

      <!-- Award Sources List -->
      <div class="awards-sources-section">
        <h4 class="settings-subsection-title">Imported Sources</h4>
        <div id="awards-sources-list" class="awards-sources-list">
          <p class="no-data">No awards imported yet</p>
        </div>
      </div>

      <!-- Unmatched Awards -->
      <div class="awards-unmatched-section">
        <h4 class="settings-subsection-title">Review Matches</h4>
        <p class="form-hint">Awards that couldn't be automatically matched to your cellar wines.</p>
        <div id="awards-unmatched-list" class="awards-unmatched-list">
          <p class="no-data">No unmatched awards</p>
        </div>
      </div>
    </div>

    <!-- Backup & Export Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Backup & Export</h3>
      <p class="settings-section-desc">Export your cellar data for backup or import from a previous backup.</p>

      <!-- Backup Stats -->
      <div class="backup-stats">
        <div class="backup-stat">
          <span class="backup-stat-value" id="backup-wines-count">-</span>
          <span class="backup-stat-label">Wines</span>
        </div>
        <div class="backup-stat">
          <span class="backup-stat-value" id="backup-bottles-count">-</span>
          <span class="backup-stat-label">Bottles</span>
        </div>
        <div class="backup-stat">
          <span class="backup-stat-value" id="backup-history-count">-</span>
          <span class="backup-stat-label">History</span>
        </div>
      </div>

      <!-- Export Options -->
      <div class="backup-export-section">
        <h4 class="settings-subsection-title">Export</h4>
        <div class="backup-buttons">
          <button class="btn btn-primary" id="export-json-btn">
            <span>üì¶</span> Full Backup (JSON)
          </button>
          <button class="btn btn-secondary" id="export-csv-btn">
            <span>üìä</span> Wine List (CSV)
          </button>
        </div>
        <p class="form-hint">JSON includes all data (wines, slots, history). CSV is for spreadsheet use.</p>
      </div>

      <!-- Import Options -->
      <div class="backup-import-section">
        <h4 class="settings-subsection-title">Import / Restore</h4>
        <div class="import-options">
          <div class="form-field">
            <label for="import-backup-file">Select Backup File</label>
            <input type="file" id="import-backup-file" accept=".json" />
          </div>
          <div class="form-field">
            <label class="checkbox-label">
              <input type="checkbox" id="import-merge-mode" />
              Merge with existing data (uncheck to replace all)
            </label>
          </div>
        </div>
        <button class="btn btn-secondary" id="import-backup-btn" disabled>
          <span>üì•</span> Import Backup
        </button>
        <p class="form-hint">Warning: Replace mode will delete all existing data before importing.</p>
      </div>
    </div>

    <!-- App Installation Section -->
    <div class="settings-section" id="pwa-install-section" style="display: none;">
      <h3 class="settings-section-title">Install App</h3>
      <p class="settings-section-desc">Install Wine Cellar as an app on your device for quick access and offline support.</p>
      <button class="btn btn-primary" id="install-app-btn">
        <span>üì≤</span> Install Wine Cellar
      </button>
    </div>

    <!-- About Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">About</h3>
      <p class="settings-about">
        Wine Cellar App v1.0<br>
        <span style="color: var(--text-muted);">Manage your wine collection with AI-powered features</span>
      </p>
      <p class="settings-about" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
        <span id="pwa-status">Web App</span>
      </p>
    </div>
  </div>
  </main>

  <!-- Wine Detail Modal -->
  <div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-wine-name">
    <div class="modal" id="wine-modal">
      <h2 id="modal-wine-name">Wine Name</h2>
      <div class="modal-subtitle" id="modal-wine-style">Style - Vintage</div>
      <div class="modal-field">
        <label>Location</label>
        <span id="modal-location">-</span>
      </div>
      <div class="modal-field">
        <label>Rating</label>
        <span id="modal-rating">-</span>
      </div>
      <div class="modal-field">
        <label>Price</label>
        <span id="modal-price">-</span>
      </div>
      <div class="modal-field" id="modal-reduce-field" style="display: none;">
        <label>Reduce Reason</label>
        <span id="modal-reduce-reason">-</span>
      </div>
      <div class="modal-field" id="modal-tasting-notes-field" style="display: none;">
        <label>Tasting Notes</label>
        <p id="modal-tasting-notes" class="tasting-notes-text">-</p>
      </div>
      <div class="modal-field serving-temp-field">
        <label>Serving Temperature</label>
        <div id="serving-temp-display">
          <span class="no-data">Loading...</span>
        </div>
      </div>
      <div id="modal-ratings-container"></div>

      <!-- Drinking Window Section -->
      <div class="drinking-window-section" id="drinking-window-section">
        <div class="section-header">
          <h4>Drinking Window</h4>
        </div>
        <div id="drinking-window-display">
          <p class="no-data">No drinking window data</p>
        </div>
        <div class="manual-window-entry" id="manual-window-entry">
          <span class="entry-label">Set window:</span>
          <div class="window-inputs">
            <input type="number" id="manual-drink-from" placeholder="From" min="1900" max="2100" />
            <span class="window-separator">to</span>
            <input type="number" id="manual-drink-by" placeholder="By" min="1900" max="2100" />
            <button type="button" class="btn btn-small btn-secondary" id="save-manual-window">Save</button>
          </div>
        </div>
      </div>

      <div class="modal-field personal-rating-section">
        <label>My Rating</label>
        <div class="personal-rating-input">
          <select id="modal-personal-rating">
            <option value="">Not rated</option>
            <option value="5">5 - Exceptional</option>
            <option value="4.5">4.5 - Excellent</option>
            <option value="4">4 - Very Good</option>
            <option value="3.5">3.5 - Good</option>
            <option value="3">3 - Acceptable</option>
            <option value="2.5">2.5 - Below Average</option>
            <option value="2">2 - Poor</option>
            <option value="1">1 - Avoid</option>
          </select>
          <button class="btn btn-small btn-secondary" id="save-personal-rating">Save</button>
        </div>
        <textarea id="modal-personal-notes" placeholder="My tasting notes..." rows="2"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-danger" id="btn-drink">Drink This</button>
        <button class="btn btn-secondary" id="btn-add-another">+ Add Another</button>
        <button class="btn btn-secondary" id="btn-edit-wine">Edit</button>
        <button class="btn btn-secondary" id="btn-close">Close</button>
      </div>
    </div>
  </div>

  <!-- Add Another Quantity Modal -->
  <div class="modal-overlay" id="add-quantity-modal-overlay">
    <div class="modal" id="add-quantity-modal" style="max-width: 380px;">
      <h2 id="add-quantity-title">Add More Bottles</h2>
      <div class="modal-subtitle" id="add-quantity-wine-name">Wine Name</div>
      <div class="form-section">
        <div class="form-field">
          <label for="add-quantity-input">How many bottles?</label>
          <input type="number" id="add-quantity-input" min="1" max="50" value="1" />
        </div>
        <div class="form-field placement-options" id="placement-options" style="display: none;">
          <span class="form-label">Placement method:</span>
          <div class="placement-radio-group">
            <label class="placement-option">
              <input type="radio" name="placement-method" value="auto" checked />
              <span class="placement-label">Auto-fill from a starting slot</span>
            </label>
            <label class="placement-option">
              <input type="radio" name="placement-method" value="manual" />
              <span class="placement-label">Select each slot manually</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="add-quantity-confirm">Continue</button>
        <button class="btn btn-secondary" id="add-quantity-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Slot Picker Overlay -->
  <div class="slot-picker-overlay" id="slot-picker-overlay">
    <div class="slot-picker-header">
      <h3 id="slot-picker-title">Add Bottle</h3>
      <p id="slot-picker-instruction">Click an empty slot</p>
      <div class="slot-picker-progress" id="slot-picker-progress" style="display: none;">
        <span id="slot-picker-placed">0</span> / <span id="slot-picker-total">1</span> placed
      </div>
      <button class="btn btn-secondary" id="cancel-slot-picker">Cancel</button>
    </div>
  </div>

  <!-- Add/Edit Bottle Modal -->
  <div class="modal-overlay" id="bottle-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="bottle-modal-title">
    <div class="modal" id="bottle-modal" style="max-width: 500px;">
      <h2 id="bottle-modal-title">Add New Bottle</h2>
      <div class="modal-subtitle" id="bottle-modal-subtitle">Adding to slot: R1C1</div>

      <form id="bottle-form">
        <!-- Search existing wines or add new -->
        <div class="form-section">
          <div class="form-toggle">
            <button type="button" class="toggle-btn active" data-mode="existing">Existing Wine</button>
            <button type="button" class="toggle-btn" data-mode="new">New Wine</button>
            <button type="button" class="toggle-btn" data-mode="parse">Scan / Import</button>
          </div>
        </div>

        <!-- Existing wine search -->
        <div class="form-section" id="existing-wine-section">
          <label class="form-label">Search your wines:</label>
          <input type="text" id="wine-search" placeholder="Type to search..." autocomplete="off" />
          <div id="wine-search-results" class="search-results"></div>
          <input type="hidden" id="selected-wine-id" />
        </div>

        <!-- Parse text/image section -->
        <div class="form-section" id="parse-wine-section" style="display: none;">

          <!-- Hidden file inputs (outside upload area to prevent event bubbling) -->
          <input type="file" id="image-file-input" hidden />
          <input type="file" id="camera-file-input" accept="image/*" capture="environment" hidden />

          <!-- Image upload area -->
          <div class="image-upload-area" id="image-upload-area">
            <div class="upload-prompt">
              <span class="upload-icon">üì∑</span>
              <span>Click to upload, drag & drop, or paste screenshot</span>
              <small>JPEG, PNG, WebP, GIF (auto-resizes large images)</small>
            </div>
            <div id="image-preview"></div>
          </div>
          <div class="image-upload-buttons">
            <button type="button" class="btn btn-secondary" id="browse-files-btn">Browse Files</button>
            <button type="button" class="btn btn-secondary" id="take-photo-btn">Take Photo</button>
          </div>

          <div class="parse-divider">
            <span>or paste/type text</span>
          </div>

          <!-- Text input area -->
          <textarea id="wine-text-input" rows="3" placeholder="Paste wine description, order confirmation, or any text containing wine info..."></textarea>

          <!-- Single unified analyze button -->
          <button type="button" class="btn btn-primary" id="analyze-wine-btn" style="margin-top: 1rem;">
            Analyze Wine
          </button>

          <div id="parse-results" style="margin-top: 1rem;"></div>
        </div>

        <!-- New wine form -->
        <div class="form-section" id="new-wine-section" style="display: none;">
          <div class="form-row">
            <div class="form-field">
              <label>Wine Name *</label>
              <input type="text" id="wine-name" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label>Vintage</label>
              <input type="number" id="wine-vintage" min="1900" max="2030" placeholder="e.g., 2023" />
            </div>
            <div class="form-field">
              <label>Colour *</label>
              <select id="wine-colour">
                <option value="red">Red</option>
                <option value="white" selected>White</option>
                <option value="rose">Ros√©</option>
                <option value="sparkling">Sparkling</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label>Style</label>
              <input type="text" id="wine-style" placeholder="e.g., Sauvignon Blanc" list="style-list" />
              <datalist id="style-list"></datalist>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label for="wine-rating">Rating</label>
              <input type="number" id="wine-rating" min="1" max="5" step="0.1" placeholder="e.g., 4.2" />
            </div>
            <div class="form-field">
              <label for="wine-price">Price (EUR)</label>
              <input type="number" id="wine-price" min="0" step="0.01" placeholder="e.g., 12.99" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label for="wine-country">Country</label>
              <select id="wine-country">
                <option value="">Select country...</option>
                <option value="Argentina">Argentina</option>
                <option value="Australia">Australia</option>
                <option value="Austria">Austria</option>
                <option value="Chile">Chile</option>
                <option value="France">France</option>
                <option value="Germany">Germany</option>
                <option value="Greece">Greece</option>
                <option value="Italy">Italy</option>
                <option value="New Zealand">New Zealand</option>
                <option value="Portugal">Portugal</option>
                <option value="South Africa">South Africa</option>
                <option value="Spain">Spain</option>
                <option value="USA">USA</option>
                <option value="Other">Other</option>
              </select>
              <input type="text" id="wine-country-other" placeholder="Enter country name..." style="display: none; margin-top: 0.5rem;" />
            </div>
          </div>

          <div class="form-row drink-window-row">
            <div class="form-field">
              <label for="wine-drink-from">Drink From</label>
              <input type="number" id="wine-drink-from" min="2000" max="2100" placeholder="e.g., 2025" />
            </div>
            <div class="form-field">
              <label for="wine-drink-peak">Peak</label>
              <input type="number" id="wine-drink-peak" min="2000" max="2100" placeholder="e.g., 2028" />
            </div>
            <div class="form-field">
              <label for="wine-drink-until">Until</label>
              <input type="number" id="wine-drink-until" min="2000" max="2100" placeholder="e.g., 2032" />
            </div>
          </div>
        </div>

        <!-- Quantity (for adding) -->
        <div class="form-section" id="quantity-section">
          <div class="form-row">
            <div class="form-field">
              <label>Quantity</label>
              <input type="number" id="bottle-quantity" min="1" max="20" value="1" />
              <span class="form-hint">Will fill consecutive slots from selected position</span>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" id="bottle-save-btn">Add Bottle</button>
          <button type="button" class="btn btn-secondary" id="bottle-cancel-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="bottle-delete-btn" style="display: none; margin-left: auto;">Remove</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Scripts -->
  <script type="module" src="/js/app.js"></script>
</body>
</html>
