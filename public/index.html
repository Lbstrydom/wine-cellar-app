<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wine Cellar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <h1>Wine Cellar</h1>
    <div class="stats" id="stats">
      <div class="stat">
        <div class="stat-value" id="stat-total">-</div>
        <div class="stat-label">Bottles</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-reduce">-</div>
        <div class="stat-label">Reduce Now</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-empty">-</div>
        <div class="stat-label">Empty Slots</div>
      </div>
    </div>
  </header>

  <nav class="tabs">
    <div class="tab active" data-view="grid">Cellar Grid</div>
    <div class="tab" data-view="reduce">Reduce Now</div>
    <div class="tab" data-view="wines">All Wines</div>
    <div class="tab" data-view="history">History</div>
    <div class="tab" data-view="pairing">Find Pairing</div>
    <div class="tab" data-view="settings">Settings</div>
  </nav>

  <!-- Grid View -->
  <div class="view active" id="view-grid">
    <div class="fridge-section zone">
      <div class="zone-header">
        <span class="zone-title">Fridge</span>
      </div>
      <div class="fridge-grid" id="fridge-grid"></div>
    </div>

    <div class="zone">
      <div class="zone-header">
        <span class="zone-title">Cellar</span>
      </div>
      <div class="cellar-grid" id="cellar-grid"></div>
    </div>
  </div>

  <!-- Reduce Now View -->
  <div class="view" id="view-reduce">
    <h2 style="margin-bottom: 1rem;">Drink These Next</h2>
    <div class="reduce-list" id="reduce-list"></div>
  </div>

  <!-- All Wines View -->
  <div class="view" id="view-wines">
    <h2 style="margin-bottom: 1rem;">All Wines</h2>
    <div class="wine-list" id="wine-list"></div>
  </div>

  <!-- History View -->
  <div class="view" id="view-history">
    <h2 style="margin-bottom: 1rem;">Consumption History</h2>
    <div class="history-list" id="history-list"></div>
  </div>

  <!-- Pairing View -->
  <div class="view" id="view-pairing">
    <!-- Sommelier section -->
    <div class="natural-pairing">
      <h2 style="margin-bottom: 1rem;">Ask the Sommelier</h2>
      <input type="text" id="dish-input" placeholder="Describe your dish... e.g., 'grilled salmon with lemon butter'" />
      <div class="pairing-filters">
        <div class="filter-group">
          <span class="filter-label">Source:</span>
          <label><input type="radio" name="source" value="all" checked> All wines</label>
          <label><input type="radio" name="source" value="reduce_now"> Reduce-now only</label>
        </div>
        <div class="filter-group">
          <span class="filter-label">Colour:</span>
          <label><input type="radio" name="colour" value="any" checked> Any</label>
          <label><input type="radio" name="colour" value="red"> Red</label>
          <label><input type="radio" name="colour" value="white"> White</label>
          <label><input type="radio" name="colour" value="rose"> Rose</label>
        </div>
      </div>
      <button class="btn btn-primary" id="ask-sommelier">Ask Sommelier</button>
    </div>

    <div id="sommelier-results"></div>

    <hr style="margin: 2rem 0; border-color: var(--border); opacity: 0.3;">

    <!-- Manual pairing section -->
    <div class="pairing-form">
      <h3 style="margin-bottom: 1rem;">Or select manually</h3>
      <h4 style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">PROTEIN</h4>
      <div class="signal-grid">
        <button class="signal-btn" data-signal="chicken">Chicken</button>
        <button class="signal-btn" data-signal="pork">Pork</button>
        <button class="signal-btn" data-signal="beef">Beef</button>
        <button class="signal-btn" data-signal="lamb">Lamb</button>
        <button class="signal-btn" data-signal="fish">Fish</button>
        <button class="signal-btn" data-signal="cheese">Cheese</button>
      </div>
      <h4 style="font-size: 0.8rem; color: var(--text-muted); margin: 1rem 0 0.5rem;">FLAVOURS</h4>
      <div class="signal-grid">
        <button class="signal-btn" data-signal="garlic_onion">Garlic/Onion</button>
        <button class="signal-btn" data-signal="herbal">Herbal</button>
        <button class="signal-btn" data-signal="roasted">Roasted</button>
        <button class="signal-btn" data-signal="acid">Acidic/Citrus</button>
        <button class="signal-btn" data-signal="sweet">Sweet</button>
        <button class="signal-btn" data-signal="umami">Umami</button>
        <button class="signal-btn" data-signal="creamy">Creamy</button>
      </div>
      <button class="btn btn-primary" style="margin-top: 1.5rem;" id="get-pairing">Find Pairing</button>
      <button class="btn btn-secondary" style="margin-top: 1.5rem;" id="clear-signals">Clear</button>
    </div>

    <h3 style="margin: 1.5rem 0 1rem;">Suggestions</h3>
    <div class="pairing-results" id="pairing-results">
      <p style="color: var(--text-muted);">Select dish characteristics above</p>
    </div>
  </div>

  <!-- Settings View -->
  <div class="view" id="view-settings">
    <h2 style="margin-bottom: 1.5rem;">Settings</h2>

    <!-- Rating Preferences Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Rating Preferences</h3>
      <p class="settings-section-desc">Adjust how professional ratings are weighted when calculating purchase scores.</p>

      <div class="preference-slider-container">
        <div class="preference-labels">
          <span>Community</span>
          <span>Balanced</span>
          <span>Competition</span>
        </div>
        <input type="range" id="rating-preference-slider" min="-100" max="100" value="40" class="preference-slider" />
        <div class="preference-value">
          <span id="preference-value-display">+40</span>
          <span id="preference-description">Slightly favors competition awards</span>
        </div>
      </div>
    </div>

    <!-- Reduce-Now Auto Rules Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Reduce-Now Auto Rules</h3>
      <p class="settings-section-desc">Automatically suggest wines to add to your reduce-now list based on criteria.</p>

      <div class="settings-toggle-row">
        <label class="toggle-switch">
          <input type="checkbox" id="reduce-auto-rules-enabled" />
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Enable automatic suggestions</span>
      </div>

      <div class="settings-rules" id="reduce-rules-container">
        <div class="settings-rule">
          <label>Suggest wines when vintage is older than</label>
          <div class="rule-input-group">
            <input type="number" id="reduce-age-threshold" min="1" max="50" value="10" />
            <span>years</span>
          </div>
        </div>

        <div class="settings-rule">
          <label>Suggest wines when rating is below</label>
          <div class="rule-input-group">
            <input type="number" id="reduce-rating-minimum" min="1" max="5" step="0.5" value="3.0" />
            <span>stars</span>
          </div>
        </div>

        <button class="btn btn-secondary" id="evaluate-rules-btn">
          Evaluate Now
        </button>
      </div>

      <!-- Evaluation Results -->
      <div id="reduce-candidates-container" style="display: none;">
        <h4 style="margin: 1rem 0 0.5rem;">Matching Wines</h4>
        <div id="reduce-candidates-list"></div>
        <div class="reduce-candidates-actions">
          <button class="btn btn-primary btn-small" id="add-all-candidates-btn">Add All to Reduce-Now</button>
          <button class="btn btn-secondary btn-small" id="clear-candidates-btn">Dismiss</button>
        </div>
      </div>
    </div>

    <!-- Account Credentials Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">Account Credentials</h3>
      <p class="settings-section-desc">Connect your accounts for enhanced rating data. Credentials are encrypted.</p>

      <div id="encryption-warning" class="settings-warning" style="display: none;">
        No encryption key configured. Add CREDENTIAL_ENCRYPTION_KEY to your .env file for persistent storage.
      </div>

      <!-- Vivino -->
      <div class="credential-form">
        <div class="credential-header">
          <span class="credential-source">Vivino</span>
          <span class="credential-status" id="vivino-status">Not configured</span>
        </div>
        <div class="credential-inputs">
          <input type="email" id="vivino-username" placeholder="Email" autocomplete="off" />
          <input type="password" id="vivino-password" placeholder="Password" autocomplete="off" />
        </div>
        <div class="credential-actions">
          <button class="btn btn-small btn-secondary" id="vivino-save-btn">Save</button>
          <button class="btn btn-small btn-secondary" id="vivino-test-btn" style="display: none;">Test</button>
          <button class="btn btn-small btn-danger" id="vivino-delete-btn" style="display: none;">Remove</button>
        </div>
      </div>

      <!-- Decanter -->
      <div class="credential-form">
        <div class="credential-header">
          <span class="credential-source">Decanter</span>
          <span class="credential-status" id="decanter-status">Not configured</span>
        </div>
        <div class="credential-inputs">
          <input type="email" id="decanter-username" placeholder="Email" autocomplete="off" />
          <input type="password" id="decanter-password" placeholder="Password" autocomplete="off" />
        </div>
        <div class="credential-actions">
          <button class="btn btn-small btn-secondary" id="decanter-save-btn">Save</button>
          <button class="btn btn-small btn-secondary" id="decanter-test-btn" style="display: none;">Test</button>
          <button class="btn btn-small btn-danger" id="decanter-delete-btn" style="display: none;">Remove</button>
        </div>
      </div>

      <!-- CellarTracker -->
      <div class="credential-form">
        <div class="credential-header">
          <span class="credential-source">CellarTracker</span>
          <span class="credential-status" id="cellartracker-status">Not configured</span>
        </div>
        <div class="credential-inputs">
          <input type="text" id="cellartracker-username" placeholder="Username" autocomplete="off" />
          <input type="password" id="cellartracker-password" placeholder="Password" autocomplete="off" />
        </div>
        <div class="credential-actions">
          <button class="btn btn-small btn-secondary" id="cellartracker-save-btn">Save</button>
          <button class="btn btn-small btn-secondary" id="cellartracker-test-btn" style="display: none;">Test</button>
          <button class="btn btn-small btn-danger" id="cellartracker-delete-btn" style="display: none;">Remove</button>
        </div>
      </div>
    </div>

    <!-- About Section -->
    <div class="settings-section">
      <h3 class="settings-section-title">About</h3>
      <p class="settings-about">
        Wine Cellar App v1.0<br>
        <span style="color: var(--text-muted);">Manage your wine collection with AI-powered features</span>
      </p>
    </div>
  </div>

  <!-- Wine Detail Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="wine-modal">
      <h2 id="modal-wine-name">Wine Name</h2>
      <div class="modal-subtitle" id="modal-wine-style">Style - Vintage</div>
      <div class="modal-field">
        <label>Location</label>
        <span id="modal-location">-</span>
      </div>
      <div class="modal-field">
        <label>Rating</label>
        <span id="modal-rating">-</span>
      </div>
      <div class="modal-field">
        <label>Price</label>
        <span id="modal-price">-</span>
      </div>
      <div class="modal-field" id="modal-reduce-field" style="display: none;">
        <label>Reduce Reason</label>
        <span id="modal-reduce-reason">-</span>
      </div>
      <div class="modal-field" id="modal-tasting-notes-field" style="display: none;">
        <label>Tasting Notes</label>
        <p id="modal-tasting-notes" class="tasting-notes-text">-</p>
      </div>
      <div id="modal-ratings-container"></div>
      <div class="modal-field personal-rating-section">
        <label>My Rating</label>
        <div class="personal-rating-input">
          <select id="modal-personal-rating">
            <option value="">Not rated</option>
            <option value="5">5 - Exceptional</option>
            <option value="4.5">4.5 - Excellent</option>
            <option value="4">4 - Very Good</option>
            <option value="3.5">3.5 - Good</option>
            <option value="3">3 - Acceptable</option>
            <option value="2.5">2.5 - Below Average</option>
            <option value="2">2 - Poor</option>
            <option value="1">1 - Avoid</option>
          </select>
          <button class="btn btn-small btn-secondary" id="save-personal-rating">Save</button>
        </div>
        <textarea id="modal-personal-notes" placeholder="My tasting notes..." rows="2"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-danger" id="btn-drink">Drink This</button>
        <button class="btn btn-secondary" id="btn-add-another">+ Add Another</button>
        <button class="btn btn-secondary" id="btn-edit-wine">Edit</button>
        <button class="btn btn-secondary" id="btn-close">Close</button>
      </div>
    </div>
  </div>

  <!-- Slot Picker Overlay -->
  <div class="slot-picker-overlay" id="slot-picker-overlay">
    <div class="slot-picker-header">
      <h3 id="slot-picker-title">Add Bottle</h3>
      <p id="slot-picker-instruction">Click an empty slot</p>
      <button class="btn btn-secondary" id="cancel-slot-picker">Cancel</button>
    </div>
  </div>

  <!-- Add/Edit Bottle Modal -->
  <div class="modal-overlay" id="bottle-modal-overlay">
    <div class="modal" id="bottle-modal" style="max-width: 500px;">
      <h2 id="bottle-modal-title">Add New Bottle</h2>
      <div class="modal-subtitle" id="bottle-modal-subtitle">Adding to slot: R1C1</div>

      <form id="bottle-form">
        <!-- Search existing wines or add new -->
        <div class="form-section">
          <div class="form-toggle">
            <button type="button" class="toggle-btn active" data-mode="existing">Existing Wine</button>
            <button type="button" class="toggle-btn" data-mode="new">New Wine</button>
            <button type="button" class="toggle-btn" data-mode="parse">Parse Text</button>
          </div>
        </div>

        <!-- Existing wine search -->
        <div class="form-section" id="existing-wine-section">
          <label class="form-label">Search your wines:</label>
          <input type="text" id="wine-search" placeholder="Type to search..." autocomplete="off" />
          <div id="wine-search-results" class="search-results"></div>
          <input type="hidden" id="selected-wine-id" />
        </div>

        <!-- Parse text/image section -->
        <div class="form-section" id="parse-wine-section" style="display: none;">

          <!-- Image upload area -->
          <div class="image-upload-area" id="image-upload-area">
            <input type="file" id="image-file-input" accept="image/jpeg,image/png,image/webp,image/gif" hidden />
            <input type="file" id="camera-file-input" accept="image/*" capture="environment" hidden />
            <div class="upload-prompt">
              <span class="upload-icon">ðŸ“·</span>
              <span>Click to upload, drag & drop, or paste screenshot</span>
              <small>JPEG, PNG, WebP, GIF (auto-resizes large images)</small>
            </div>
            <div id="image-preview"></div>
          </div>
          <div class="image-upload-buttons">
            <button type="button" class="btn btn-secondary" id="browse-files-btn">Browse Files</button>
            <button type="button" class="btn btn-secondary" id="take-photo-btn">Take Photo</button>
          </div>

          <button type="button" class="btn btn-secondary" id="parse-image-btn" style="display: none; margin-top: 0.5rem;">
            Parse Image with AI
          </button>

          <div class="parse-divider">
            <span>or paste/type text</span>
          </div>

          <!-- Text input area -->
          <textarea id="wine-text-input" rows="3" placeholder="Paste wine description, order confirmation, or any text containing wine info..."></textarea>

          <button type="button" class="btn btn-secondary" id="parse-text-btn" style="margin-top: 0.5rem;">
            Parse Text with AI
          </button>

          <div id="parse-results" style="margin-top: 1rem;"></div>
        </div>

        <!-- New wine form -->
        <div class="form-section" id="new-wine-section" style="display: none;">
          <div class="form-row">
            <div class="form-field">
              <label>Wine Name *</label>
              <input type="text" id="wine-name" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label>Vintage</label>
              <input type="number" id="wine-vintage" min="1900" max="2030" placeholder="e.g., 2023" />
            </div>
            <div class="form-field">
              <label>Colour *</label>
              <select id="wine-colour">
                <option value="red">Red</option>
                <option value="white" selected>White</option>
                <option value="rose">RosÃ©</option>
                <option value="sparkling">Sparkling</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label>Style</label>
              <input type="text" id="wine-style" placeholder="e.g., Sauvignon Blanc" list="style-list" />
              <datalist id="style-list"></datalist>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label for="wine-rating">Rating</label>
              <input type="number" id="wine-rating" min="1" max="5" step="0.1" placeholder="e.g., 4.2" />
            </div>
            <div class="form-field">
              <label for="wine-price">Price (EUR)</label>
              <input type="number" id="wine-price" min="0" step="0.01" placeholder="e.g., 12.99" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label for="wine-country">Country</label>
              <input type="text" id="wine-country" placeholder="e.g., South Africa" />
            </div>
          </div>

          <div class="form-row drink-window-row">
            <div class="form-field">
              <label for="wine-drink-from">Drink From</label>
              <input type="number" id="wine-drink-from" min="2000" max="2100" placeholder="e.g., 2025" />
            </div>
            <div class="form-field">
              <label for="wine-drink-peak">Peak</label>
              <input type="number" id="wine-drink-peak" min="2000" max="2100" placeholder="e.g., 2028" />
            </div>
            <div class="form-field">
              <label for="wine-drink-until">Until</label>
              <input type="number" id="wine-drink-until" min="2000" max="2100" placeholder="e.g., 2032" />
            </div>
          </div>
        </div>

        <!-- Quantity (for adding) -->
        <div class="form-section" id="quantity-section">
          <div class="form-row">
            <div class="form-field">
              <label>Quantity</label>
              <input type="number" id="bottle-quantity" min="1" max="20" value="1" />
              <span class="form-hint">Will fill consecutive slots from selected position</span>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" id="bottle-save-btn">Add Bottle</button>
          <button type="button" class="btn btn-secondary" id="bottle-cancel-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="bottle-delete-btn" style="display: none; margin-left: auto;">Remove</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Scripts -->
  <script type="module" src="/js/app.js"></script>
</body>
</html>
