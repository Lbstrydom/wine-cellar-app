name: PostgreSQL Compatibility Tests

on:
  push:
    branches: [main]
    paths:
      - 'src/**/*.js'
      - 'scripts/test-pg-compat.js'
      - 'package.json'
  pull_request:
    branches: [main]
    paths:
      - 'src/**/*.js'
      - 'scripts/test-pg-compat.js'
      - 'package.json'
  workflow_dispatch:

jobs:
  test-sqlite:
    name: Test SQLite Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run SQLite compatibility tests
        run: npm run test:pg

  test-postgres:
    name: Test PostgreSQL Compatibility
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: wine_cellar_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U testuser; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Initialize PostgreSQL schema
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/wine_cellar_test
        run: |
          # Create tables needed for tests
          PGPASSWORD=testpass psql -h localhost -U testuser -d wine_cellar_test << 'EOF'
          CREATE TABLE IF NOT EXISTS wines (
            id SERIAL PRIMARY KEY,
            wine_name TEXT NOT NULL,
            vintage INTEGER,
            colour TEXT,
            style TEXT,
            country TEXT,
            vivino_rating REAL,
            price_eur REAL,
            personal_rating REAL,
            personal_notes TEXT,
            drink_from INTEGER,
            drink_peak INTEGER,
            drink_until INTEGER,
            purchase_stars INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          CREATE TABLE IF NOT EXISTS slots (
            id SERIAL PRIMARY KEY,
            location_code TEXT NOT NULL,
            wine_id INTEGER REFERENCES wines(id)
          );

          CREATE TABLE IF NOT EXISTS reduce_now (
            id SERIAL PRIMARY KEY,
            wine_id INTEGER REFERENCES wines(id),
            priority INTEGER DEFAULT 5,
            reduce_reason TEXT
          );

          CREATE TABLE IF NOT EXISTS user_settings (
            key TEXT PRIMARY KEY,
            value TEXT
          );

          -- Insert test data
          INSERT INTO wines (wine_name, vintage, colour, style, country)
          VALUES
            ('Test Shiraz', 2020, 'Red', 'Shiraz', 'Australia'),
            ('Test Chardonnay', 2021, 'White', 'Chardonnay', 'France'),
            ('Test Cabernet', 2019, 'Red', 'Cabernet Sauvignon', 'USA');

          INSERT INTO slots (location_code, wine_id) VALUES ('A1', 1), ('A2', 1), ('B1', 2);
          EOF

      - name: Run PostgreSQL compatibility tests
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/wine_cellar_test
        run: npm run test:pg

  lint:
    name: Lint Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
